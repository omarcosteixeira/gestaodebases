<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Bases Oeste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        /* Estilo para garantir que o input de data no iOS não tenha bordas estranhas */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Container principal com largura limitada para melhor visualização em telas grandes -->
    <div id="app" class="flex flex-1 flex-col p-4 md:p-8 mx-auto w-full max-w-screen-xl">
        <!-- Tela de Autenticação -->
        <div id="auth-screen" class="flex flex-col items-center justify-center flex-1">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
                <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Gestão de Bases Oeste</h1>
                <div id="auth-form-container">
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Entrar</button>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Não tem uma conta? <a href="#" id="show-register" class="text-sky-600 hover:underline">Cadastre-se</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela Principal da Ferramenta -->
        <div id="main-app" class="hidden flex-1 flex-col">
            <!-- Cabeçalho -->
            <header class="bg-sky-600 text-white p-4 rounded-b-xl shadow-lg mb-8 flex justify-between items-center flex-wrap gap-4">
                <h1 class="text-2xl font-bold">Gestão de Bases Oeste</h1>
                <div class="flex items-center space-x-4 flex-wrap gap-2">
                    <span id="user-info" class="font-semibold text-sm"></span>
                    <button id="change-password-btn" class="bg-white text-sky-600 px-4 py-2 rounded-xl font-semibold hover:bg-gray-100 transition duration-300 shadow-sm text-sm">Mudar Senha</button>
                    <button id="logout-button" class="bg-white text-sky-600 px-4 py-2 rounded-xl font-semibold hover:bg-gray-100 transition duration-300 shadow-sm text-sm">Sair</button>
                </div>
            </header>

            <!-- Seções da Ferramenta -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1">
                <!-- Seção de Cadastro -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Cadastro de Base</h2>
                    <form id="base-form" class="space-y-4">
                        <div>
                            <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="data" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="nomeBase" class="block text-sm font-medium text-gray-700">Nome da Base</label>
                            <input type="text" id="nomeBase" placeholder="Ex: Campanha Verão" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="nomeAtendente" class="block text-sm font-medium text-gray-700">Nome do Atendente</label>
                            <!-- Este campo será preenchido automaticamente, mas pode ser alterado -->
                            <input type="text" id="nomeAtendente" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="meioDisparo" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="meioDisparo" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                <option value="">Selecione...</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                            </select>
                        </div>
                        <div>
                            <label for="quantidadeDisparos" class="block text-sm font-medium text-gray-700">Quantidade de Disparos</label>
                            <input type="number" id="quantidadeDisparos" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required min="0">
                        </div>
                        <div>
                            <label for="positivos" class="block text-sm font-medium text-gray-700">Quantidade de Positivos</label>
                            <input type="number" id="positivos" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required min="0">
                        </div>
                        <div>
                            <label for="negativos" class="block text-sm font-medium text-gray-700">Quantidade de Negativos</label>
                            <input type="number" id="negativos" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required min="0">
                        </div>
                        <div>
                            <label for="evidencia" class="block text-sm font-medium text-gray-700">Evidência (URL ou Observações)</label>
                            <input type="text" id="evidencia" placeholder="Link para o relatório ou observações" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Salvar Dados</button>
                    </form>
                </div>

                <!-- Seção de Relatórios -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 class="text-xl font-bold text-gray-800">Relatórios de Desempenho</h2>
                        <div id="report-controls" class="flex space-x-2">
                            <!-- Botões de período podem ser adicionados aqui para facilitar a filtragem por data -->
                            <button id="report-hoje" class="px-3 py-1 text-xs rounded-full bg-sky-500 text-white font-semibold hover:bg-sky-600 transition">Hoje</button>
                            <button id="report-esta-semana" class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Esta Semana</button>
                            <button id="report-este-mes" class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Este Mês</button>
                        </div>
                    </div>
                    
                    <div id="report-filters" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="filter-atendente" class="block text-sm font-medium text-gray-700">Atendente</label>
                            <select id="filter-atendente" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-meio" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="filter-meio" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                                <option value="all">Todos</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                            </select>
                        </div>
                        <div id="filter-unidade-container" class="hidden">
                            <label for="filter-unidade" class="block text-sm font-medium text-gray-700">Unidade</label>
                            <select id="filter-unidade" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                                <option value="all">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                            <input type="date" id="filter-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Data Final</label>
                            <input type="date" id="filter-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                    
                    <div id="report-summary" class="mt-6 p-4 bg-gray-100 rounded-xl border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Resumo do Período</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div><span class="font-medium">Total de Disparos:</span> <span id="summary-disparos" class="font-bold text-sky-600">0</span></div>
                            <div><span class="font-medium">Total de Positivos:</span> <span id="summary-positivos" class="font-bold text-green-600">0</span></div>
                            <div><span class="font-medium">Total de Negativos:</span> <span id="summary-negativos" class="font-bold text-red-600">0</span></div>
                            <div><span class="font-medium">Taxa de Conversão:</span> <span id="summary-conversao" class="font-bold text-purple-600">0.00%</span></div>
                        </div>
                    </div>

                    <!-- Botões de Exportação -->
                    <div class="mt-6 flex justify-end space-x-4">
                        <button id="export-pdf-btn" class="bg-gray-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-gray-600 transition duration-300 shadow-md flex items-center">
                            <!-- Ícone PDF SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a1 1 0 00-.293-.707l-4-4A1 1 0 0013 2H5zm2 5a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H8zm2 4a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                            </svg>
                            Exportar PDF
                        </button>
                        <button id="export-excel-btn" class="bg-green-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-600 transition duration-300 shadow-md flex items-center">
                            <!-- Ícone Excel SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4a2 2 0 00-2 2v8a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2H5zm10 2H5v1h10V6zm-9 3a1 1 0 011-1h5a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h5a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                            Exportar CSV
                        </button>
                    </div>
                    
                    <!-- Tabela de Dados Brutos -->
                    <div class="mt-8 overflow-x-auto">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Bases Cadastradas (Dados Brutos)</h3>
                        <table class="min-w-full bg-white border border-gray-200 rounded-xl">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-3 px-6 text-left">Data</th>
                                    <th class="py-3 px-6 text-left">Base</th>
                                    <th class="py-3 px-6 text-left">Atendente</th>
                                    <th class="py-3 px-6 text-left">Unidade</th>
                                    <th class="py-3 px-6 text-left">Meio</th>
                                    <th class="py-3 px-6 text-left">Disparos</th>
                                    <th class="py-3 px-6 text-left">Positivos</th>
                                    <th class="py-3 px-6 text-left">Negativos</th>
                                    <th class="py-3 px-6 text-left">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="bases-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Dados serão inseridos aqui pelo JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Seção de Administrador -->
            <div id="admin-panel" class="hidden mt-8 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Painel do Administrador: Gerenciamento de Usuários</h2>
                
                <!-- Formulário para Criar Novo Usuário -->
                <div class="mb-8 p-4 border border-gray-200 rounded-xl bg-gray-50">
                    <h3 class="font-semibold text-gray-700 mb-2">Criar Novo Usuário (Apenas usuários normais)</h3>
                    <form id="create-user-form" class="space-y-4">
                        <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-xl" required>
                        <input type="email" id="new-user-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl" required>
                        <input type="password" id="new-user-password" placeholder="Senha (mínimo 6 caracteres)" class="w-full p-3 border border-gray-300 rounded-xl" required minlength="6">
                        <input type="text" id="new-user-unidade" placeholder="Unidade (Ex: Leste, Sul)" class="w-full p-3 border border-gray-300 rounded-xl" required>
                        <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-xl font-semibold hover:bg-green-700 transition shadow-md">Criar Usuário</button>
                    </form>
                </div>

                <!-- Tabela para Gerenciar Usuários -->
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Gerenciar Usuários Existentes</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-xl">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-3 px-6 text-left">Nome</th>
                                    <th class="py-3 px-6 text-left">E-mail</th>
                                    <th class="py-3 px-6 text-left">Unidade</th>
                                    <th class="py-3 px-6 text-left">Acesso Total (Admin/Visão)</th>
                                    <th class="py-3 px-6 text-left">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Dados dos usuários serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pop-up de mensagens (Modal Genérico) -->
        <div id="message-modal" class="hidden fixed inset-0 z-50 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all">
                <p id="message-text" class="text-center text-gray-800 mb-4 font-medium"></p>
                <div class="flex justify-center space-x-4">
                    <button id="close-modal" class="bg-sky-600 text-white p-2 rounded-xl font-semibold hover:bg-sky-700 transition w-20">OK</button>
                    <button id="confirm-action" class="hidden bg-red-600 text-white p-2 rounded-xl font-semibold hover:bg-red-700 transition w-20">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal para Mudar Senha -->
        <div id="password-modal" class="hidden fixed inset-0 z-50 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">Mudar Senha</h3>
                <form id="change-password-form" class="space-y-4">
                    <input type="password" id="new-password" placeholder="Nova Senha (mínimo 6 caracteres)" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required minlength="6">
                    <input type="password" id="confirm-new-password" placeholder="Confirme a Nova Senha" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required minlength="6">
                    <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Mudar Senha</button>
                </form>
                <div class="flex justify-center mt-4">
                    <button id="close-password-modal" class="bg-gray-400 text-white p-2 rounded-xl font-semibold hover:bg-gray-500 transition">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Rodapé -->
    <footer class="text-center text-gray-500 text-xs p-4">
        Sistema Gestão de Bases Oeste | Desenvolvido com Firebase e Tailwind CSS
    </footer>

    <!-- Bibliotecas de terceiros (jsPDF deve ser carregado antes do autotable plugin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module">
        // Importações modulares do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, onSnapshot, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuração e Inicialização do Firebase ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Configuração de fallback segura. A chave API real será fornecida pelo ambiente.
            apiKey: "", 
            authDomain: `${appId}.firebaseapp.com`,
            projectId: appId,
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            // Uso de `showMessage` garantido após a definição
        }

        let currentUserId = null;
        let currentUserRole = null;
        let currentUserUnit = null;
        let currentUserCanViewAllUnits = false;
        let allBasesData = [];
        let currentDeleteDocId = null;

        // --- Referências ao DOM ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerFormContainer = document.getElementById('auth-form-container');
        const baseForm = document.getElementById('base-form');
        const nomeAtendenteInput = document.getElementById('nomeAtendente');
        const adminPanel = document.getElementById('admin-panel');
        const createUserForm = document.getElementById('create-user-form');
        const userInfoSpan = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const basesTableBody = document.getElementById('bases-table-body');
        const reportHojeBtn = document.getElementById('report-hoje');
        const reportEstaSemanaBtn = document.getElementById('report-esta-semana');
        const reportEsteMesBtn = document.getElementById('report-este-mes');
        const filterAtendenteSelect = document.getElementById('filter-atendente');
        const filterMeioSelect = document.getElementById('filter-meio');
        const filterUnidadeSelect = document.getElementById('filter-unidade');
        const filterStartDateInput = document.getElementById('filter-start-date');
        const filterEndDateInput = document.getElementById('filter-end-date');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const closeModalBtn = document.getElementById('close-modal');
        const confirmActionBtn = document.getElementById('confirm-action');
        const usersTableBody = document.getElementById('users-table-body');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const filterUnidadeContainer = document.getElementById('filter-unidade-container');
        const passwordModal = document.getElementById('password-modal');
        const changePasswordForm = document.getElementById('change-password-form');
        const closePasswordModalBtn = document.getElementById('close-password-modal');

        // --- Funções Auxiliares ---

        // Função para formatar a data (YYYY-MM-DD)
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }
        
        // Função para obter o início e o fim da semana
        function getWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Domingo) a 6 (Sábado)
            
            // Início da semana (Domingo)
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);

            // Fim da semana (Sábado)
            const endOfWeek = new Date(now);
            endOfWeek.setDate(now.getDate() + (6 - dayOfWeek));
            endOfWeek.setHours(23, 59, 59, 999);
            
            return {
                start: formatDate(startOfWeek),
                end: formatDate(endOfWeek)
            };
        }

        // Função para obter o início e o fim do mês
        function getMonthRange() {
            const now = new Date();
            
            // Início do mês (Dia 1)
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            // Fim do mês (Último dia)
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            endOfMonth.setHours(23, 59, 59, 999);

            return {
                start: formatDate(startOfMonth),
                end: formatDate(endOfMonth)
            };
        }

        // Função para mostrar mensagens em um modal
        function showMessage(message, isConfirmation = false, onConfirm = null) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
            if (isConfirmation) {
                closeModalBtn.classList.add('hidden');
                confirmActionBtn.classList.remove('hidden');
                confirmActionBtn.onclick = onConfirm;
            } else {
                closeModalBtn.classList.remove('hidden');
                confirmActionBtn.classList.add('hidden');
            }
        }
        
        closeModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // --- Lógica de Autenticação e Usuário ---

        // Alterna entre login e cadastro
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.innerHTML = `
                <form id="register-form" class="space-y-4">
                    <input type="text" id="register-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <input type="email" id="register-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required minlength="6">
                    <input type="text" id="register-unidade" placeholder="Unidade (Ex: Leste, Sul)" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Cadastrar</button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">
                        Já tem uma conta? <a href="#" id="show-login" class="text-sky-600 hover:underline">Entrar</a>
                    </p>
                </div>
            `;
            // Adiciona o event listener para o novo formulário de registro
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                location.reload(); // Recarrega para voltar à tela de login original
            });
        });

        // Lidar com o login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage(`Erro ao fazer login: ${error.message}`);
            }
        }
        loginForm.addEventListener('submit', handleLogin);

        // Lidar com o registro
        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const unidade = document.getElementById('register-unidade').value;

            try {
                // Checa se já existe um admin para o app.
                const adminDoc = await getDoc(doc(db, "app_state", "admin"));
                let isFirstUser = !adminDoc.exists();

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userRole = isFirstUser ? 'admin' : 'user';
                const userUnidade = unidade;
                const canViewAllUnits = isFirstUser;

                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    unidade: userUnidade,
                    role: userRole,
                    canViewAllUnits: canViewAllUnits
                });
                
                if (isFirstUser) {
                    await setDoc(doc(db, "app_state", "admin"), { adminId: user.uid });
                }
                
                showMessage(`Usuário ${name} cadastrado com sucesso! Faça login para continuar.`);
                location.reload(); // Recarrega para forçar o login
            } catch (error) {
                showMessage(`Erro ao cadastrar: ${error.message}`);
            }
        }

        // Lidar com a criação de usuário pelo admin
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const unidade = document.getElementById('new-user-unidade').value;
            
            if (password.length < 6) {
                 showMessage("A senha deve ter no mínimo 6 caracteres.");
                 return;
            }

            try {
                // Cria o usuário na Autenticação (funciona apenas com a API Key de Admin/Service Account)
                // Nota: O Firebase Client SDK permite a criação pelo Admin, mas não a exclusão.
                const newUserCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", newUserCredential.user.uid), {
                    name, email, unidade, role: 'user', canViewAllUnits: false
                });
                showMessage(`Novo usuário (${email}) criado com sucesso!`);
                createUserForm.reset();
            } catch (error) {
                showMessage(`Erro ao criar usuário: ${error.message}`);
            }
        });

        // Lidar com a troca de senha do usuário
        changePasswordBtn.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
        });

        closePasswordModalBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            changePasswordForm.reset();
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;

            if (newPassword !== confirmNewPassword) {
                showMessage("As senhas não coincidem. Por favor, tente novamente.");
                return;
            }

            if (newPassword.length < 6) {
                showMessage("A senha deve ter no mínimo 6 caracteres.");
                return;
            }

            try {
                await updatePassword(auth.currentUser, newPassword);
                showMessage("Senha alterada com sucesso!");
                passwordModal.classList.add('hidden');
                changePasswordForm.reset();
            } catch (error) {
                showMessage(`Erro ao mudar a senha: ${error.message}. Tente fazer login novamente se o erro persistir.`);
            }
        });
        
        // Lidar com o estado de autenticação
        onAuthStateChanged(auth, async (user) => {
            if (user && db) {
                currentUserId = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');

                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    currentUserUnit = userData.unidade;
                    currentUserCanViewAllUnits = userData.canViewAllUnits || (currentUserRole === 'admin');
                    
                    userInfoSpan.textContent = `${userData.name} (${userData.unidade}) - ID: ${user.uid}`;
                    document.getElementById('nomeAtendente').value = userData.name || '';
                    document.getElementById('data').value = formatDate(new Date());

                    if (currentUserRole === 'admin') {
                        adminPanel.classList.remove('hidden');
                        filterUnidadeContainer.classList.remove('hidden');
                        setupUsersListener();
                    } else {
                        adminPanel.classList.add('hidden');
                        filterUnidadeContainer.classList.add('hidden');
                    }
                    
                    setupDataListener();
                } else {
                    // Se o documento do usuário não existir (apenas Auth), força o logout
                    await signOut(auth);
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserUnit = null;
                currentUserCanViewAllUnits = false;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                basesTableBody.innerHTML = '';
            }
        });

        // --- Gerenciamento de Dados (Firestore) ---

        // Configura o listener para a coleção de usuários no painel do admin
        function setupUsersListener() {
            if (currentUserRole !== 'admin') return;

            onSnapshot(collection(db, "users"), (snapshot) => {
                const usersData = [];
                const allUnits = new Set();
                snapshot.forEach(doc => {
                    const user = { ...doc.data(), id: doc.id };
                    usersData.push(user);
                    allUnits.add(user.unidade);
                });
                renderUsersTable(usersData);
            });
        }

        // Renderiza a tabela de usuários
        function renderUsersTable(users) {
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const isCurrentUser = user.id === currentUserId;
                const isAdmin = user.role === 'admin';
                // Adiciona a unidade à coluna, visível apenas para admins (que já estão no painel)
                const isUnitViewer = user.canViewAllUnits && !isAdmin; 
                
                const permissionText = isAdmin ? 'Admin' : (isUnitViewer ? 'Visão Unidades' : 'Usuário');

                const row = `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 px-6 text-left">${user.name}</td>
                        <td class="py-3 px-6 text-left">${user.email}</td>
                        <td class="py-3 px-6 text-left">${user.unidade}</td>
                        <td class="py-3 px-6 text-center">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${isAdmin ? 'bg-purple-100 text-purple-800' : (isUnitViewer ? 'bg-sky-100 text-sky-800' : 'bg-gray-100 text-gray-800')}">${permissionText}</span>
                            ${!isAdmin && !isCurrentUser ? `<input type="checkbox" data-user-id="${user.id}" class="ml-2 form-checkbox h-4 w-4 text-sky-600 rounded" ${isUnitViewer ? 'checked' : ''}>` : ''}
                        </td>
                        <td class="py-3 px-6 text-center">
                            <button onclick="deleteUser('${user.id}')" class="bg-red-500 text-white px-3 py-1 text-xs rounded-xl font-semibold hover:bg-red-600 transition shadow-sm ${isCurrentUser || isAdmin ? 'opacity-50 cursor-not-allowed' : ''}" ${isCurrentUser || isAdmin ? 'disabled' : ''}>Excluir Doc</button>
                        </td>
                    </tr>
                `;
                usersTableBody.innerHTML += row;
            });

            // Adiciona event listeners para os checkboxes de permissão
            usersTableBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const userId = e.target.dataset.userId;
                    updateUserPermission(userId, e.target.checked);
                });
            });
        }
        
        // Atualiza a permissão de um usuário
        async function updateUserPermission(userId, canViewAllUnits) {
            try {
                await updateDoc(doc(db, "users", userId), { canViewAllUnits: canViewAllUnits });
                showMessage(`Permissão de visão de unidades atualizada para o usuário ${userId}.`);
            } catch (error) {
                showMessage(`Erro ao atualizar a permissão: ${error.message}`);
            }
        }
        
        // Exclui um usuário (apenas o documento do Firestore)
        window.deleteUser = function(userId) {
            if (userId === currentUserId) return; // Não permite excluir a si mesmo
            
            showMessage('Tem certeza que deseja excluir o DOCUMENTO (Registro) deste usuário? \nATENÇÃO: Isso não exclui a conta de login (Auth). A exclusão total requer um serviço de backend (Cloud Function).', true, async () => {
                try {
                    await deleteDoc(doc(db, "users", userId));
                    showMessage('Documento de usuário excluído com sucesso!');
                    console.warn(`O documento Firestore do usuário ${userId} foi removido, mas a conta Firebase Authentication permanece. Para exclusão total, utilize o console do Firebase ou Cloud Functions.`);
                } catch (error) {
                    showMessage(`Erro ao excluir o documento do usuário: ${error.message}`);
                } finally {
                    messageModal.classList.add('hidden');
                }
            });
        };

        // Função para configurar o listener de dados do Firestore para as bases
        async function setupDataListener() {
            let basesRef = collection(db, "bases");
            let q;
            let allUnits = new Set();
            
            // 1. Coleta todas as unidades e atendentes (necessário para filtros)
            const usersSnapshot = await getDocs(collection(db, "users"));
            const allAtendentes = new Set();
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                allUnits.add(userData.unidade);
                allAtendentes.add(userData.name);
            });
            
            // Preenche o seletor de unidades (apenas visível para quem tem permissão)
            if (currentUserRole === 'admin' || currentUserCanViewAllUnits) {
                filterUnidadeSelect.innerHTML = '<option value="all">Todas</option>';
                allUnits.forEach(unidade => {
                    filterUnidadeSelect.innerHTML += `<option value="${unidade}">${unidade}</option>`;
                });
            }

            // 2. Define a query de dados
            if (currentUserRole === 'admin' || currentUserCanViewAllUnits) {
                // Admins ou usuários com visão total: sem filtro de unidade na query
                q = query(basesRef);
            } else {
                // Usuário normal: consulta apenas as bases da sua unidade
                q = query(basesRef, where("unidade", "==", currentUserUnit));
            }
            
            // Adiciona listener para a coleção de bases
            onSnapshot(q, (snapshot) => {
                allBasesData = [];
                // Reconstroi o set de atendentes do *documento* users, não dos dados de base.
                // Mas, para o filtro, precisamos dos atendentes que *têm* bases.
                const atendentesComDados = new Set();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allBasesData.push({ ...data, id: doc.id });
                    atendentesComDados.add(data.nomeAtendente);
                });

                // Preenche o seletor de atendentes
                filterAtendenteSelect.innerHTML = '<option value="all">Todos</option>';
                // Usa o nome do atendente logado primeiro, se existir
                if (nomeAtendenteInput.value && !atendentesComDados.has(nomeAtendenteInput.value)) {
                    atendentesComDados.add(nomeAtendenteInput.value);
                }
                
                // Ordena os atendentes e preenche o filtro
                Array.from(atendentesComDados).sort().forEach(atendente => {
                    filterAtendenteSelect.innerHTML += `<option value="${atendente}">${atendente}</option>`;
                });
                
                generateReport();
            }, (error) => {
                console.error("Erro ao carregar dados:", error);
                showMessage("Erro ao carregar bases do Firestore. Verifique as regras de segurança.");
            });
        }

        // Função para renderizar a tabela de bases
        function renderBasesTable(data) {
            basesTableBody.innerHTML = '';
            if (data.length === 0) {
                basesTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">Nenhum dado encontrado para esta seleção.</td></tr>`;
            } else {
                data.sort((a, b) => new Date(b.data) - new Date(a.data)); // Ordena por data mais recente
                data.forEach((item) => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${item.data}</td>
                            <td class="py-3 px-6 text-left">${item.nomeBase}</td>
                            <td class="py-3 px-6 text-left">${item.nomeAtendente}</td>
                            <td class="py-3 px-6 text-left">${item.unidade}</td>
                            <td class="py-3 px-6 text-left">${item.meioDisparo}</td>
                            <td class="py-3 px-6 text-left">${item.quantidadeDisparos}</td>
                            <td class="py-3 px-6 text-left">${item.positivos}</td>
                            <td class="py-3 px-6 text-left">${item.negativos}</td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="deleteBase('${item.id}')" class="bg-red-500 text-white px-3 py-1 text-xs rounded-xl font-semibold hover:bg-red-600 transition shadow-sm">Excluir</button>
                            </td>
                        </tr>
                    `;
                    basesTableBody.innerHTML += row;
                });
            }
        }

        // Função para excluir uma base
        window.deleteBase = function(docId) {
            currentDeleteDocId = docId;
            showMessage('Tem certeza que deseja excluir este relatório?', true, async () => {
                try {
                    await deleteDoc(doc(db, "bases", currentDeleteDocId));
                    showMessage('Relatório excluído com sucesso!');
                } catch (error) {
                    showMessage(`Erro ao excluir o relatório: ${error.message}`);
                } finally {
                    messageModal.classList.add('hidden');
                }
            });
        };

        // Lidar com o envio do formulário de base
        baseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const disparos = parseInt(document.getElementById('quantidadeDisparos').value);
                const positivos = parseInt(document.getElementById('positivos').value);
                const negativos = parseInt(document.getElementById('negativos').value);

                if (positivos + negativos > disparos) {
                    showMessage('A soma de Positivos e Negativos não pode ser maior que a Quantidade de Disparos.');
                    return;
                }

                const data = {
                    data: document.getElementById('data').value,
                    nomeBase: document.getElementById('nomeBase').value,
                    nomeAtendente: nomeAtendenteInput.value,
                    meioDisparo: document.getElementById('meioDisparo').value,
                    quantidadeDisparos: disparos,
                    positivos: positivos,
                    negativos: negativos,
                    evidencia: document.getElementById('evidencia').value || "",
                    userId: currentUserId,
                    unidade: currentUserUnit,
                    createdAt: new Date().toISOString() // Adiciona timestamp
                };
                await addDoc(collection(db, "bases"), data);
                showMessage('Dados salvos com sucesso!');
                baseForm.reset();
                document.getElementById('nomeAtendente').value = nomeAtendenteInput.value; // Mantém o nome preenchido
                document.getElementById('data').value = formatDate(new Date());
            } catch (error) {
                showMessage(`Erro ao salvar dados: ${error.message}`);
            }
        });

        // Lidar com o logout
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                showMessage(`Erro ao sair: ${error.message}`);
            }
        });

        // --- Lógica de Relatórios e Filtros ---

        // Configura o botão de filtro de período
        function setActiveReportButton(activeId) {
            [reportHojeBtn, reportEstaSemanaBtn, reportEsteMesBtn].forEach(btn => {
                if (btn.id === activeId) {
                    btn.classList.replace('bg-gray-200', 'bg-sky-500');
                    btn.classList.replace('text-gray-700', 'text-white');
                } else {
                    btn.classList.replace('bg-sky-500', 'bg-gray-200');
                    btn.classList.replace('text-white', 'text-gray-700');
                }
            });
        }

        reportHojeBtn.addEventListener('click', () => { 
            const today = formatDate(new Date());
            filterStartDateInput.value = today;
            filterEndDateInput.value = today;
            setActiveReportButton('report-hoje');
            generateReport(); 
        });
        reportEstaSemanaBtn.addEventListener('click', () => { 
            const range = getWeekRange();
            filterStartDateInput.value = range.start;
            filterEndDateInput.value = range.end;
            setActiveReportButton('report-esta-semana');
            generateReport(); 
        });
        reportEsteMesBtn.addEventListener('click', () => { 
            const range = getMonthRange();
            filterStartDateInput.value = range.start;
            filterEndDateInput.value = range.end;
            setActiveReportButton('report-este-mes');
            generateReport(); 
        });

        // Event listeners para filtros de seleção e data
        filterAtendenteSelect.addEventListener('change', generateReport);
        filterMeioSelect.addEventListener('change', generateReport);
        if (filterUnidadeSelect) {
            filterUnidadeSelect.addEventListener('change', generateReport);
        }
        filterStartDateInput.addEventListener('change', generateReport);
        filterEndDateInput.addEventListener('change', generateReport);


        // Função principal para filtrar e gerar o relatório
        function generateReport() {
            const filteredData = filterData();
            
            let totalDisparos = 0;
            let totalPositivos = 0;
            let totalNegativos = 0;

            filteredData.forEach(item => {
                totalDisparos += item.quantidadeDisparos;
                totalPositivos += item.positivos;
                totalNegativos += item.negativos;
            });
            
            const taxaConversao = totalDisparos > 0 ? ((totalPositivos / totalDisparos) * 100).toFixed(2) : '0.00';
            
            document.getElementById('summary-disparos').textContent = totalDisparos;
            document.getElementById('summary-positivos').textContent = totalPositivos;
            document.getElementById('summary-negativos').textContent = totalNegativos;
            document.getElementById('summary-conversao').textContent = `${taxaConversao}%`;
            
            renderBasesTable(filteredData);
        }

        function filterData() {
            let data = [...allBasesData];
            const atendente = filterAtendenteSelect.value;
            const meio = filterMeioSelect.value;
            // A unidade só é usada no filtro se o usuário puder ver todas as unidades.
            const unidade = (currentUserRole === 'admin' || currentUserCanViewAllUnits) && filterUnidadeSelect ? filterUnidadeSelect.value : currentUserUnit;
            const startDate = filterStartDateInput.value;
            const endDate = filterEndDateInput.value;

            if (atendente !== 'all') {
                data = data.filter(base => base.nomeAtendente === atendente);
            }
            if (meio !== 'all') {
                data = data.filter(base => base.meioDisparo === meio);
            }
            // Filtro por unidade
            if (unidade !== 'all') {
                 data = data.filter(base => base.unidade === unidade);
            }
            
            // Filtros de data (incluindo o dia da data final)
            if (startDate) {
                data = data.filter(base => base.data >= startDate);
            }
            if (endDate) {
                data = data.filter(base => base.data <= endDate);
            }
            
            return data;
        }

        // --- Lógica de Exportação ---
        
        // Exportação para PDF
        exportPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            if (typeof jsPDF === 'undefined' || typeof doc.autoTable === 'undefined') {
                showMessage('Erro: Bibliotecas de PDF não carregadas corretamente.');
                return;
            }

            const doc = new jsPDF('p', 'pt', 'a4');
            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            const filteredData = filterData();
            
            if (filteredData.length === 0) {
                 showMessage('Não há dados filtrados para exportar para PDF.');
                 return;
            }
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text("Relatório de Gestão de Bases", pageWidth / 2, margin, { align: 'center' });

            let y = margin + 30;

            // Adiciona o resumo
            doc.setFontSize(10);
            const summaryText = document.getElementById('report-summary').innerText.replace(/\sTaxa de Conversão:/g, '\nTaxa de Conversão:'); // Quebra de linha para melhor formatação
            const summaryLines = doc.splitTextToSize(summaryText, 520);
            doc.text(summaryLines, margin, y);
            y += doc.getTextDimensions(summaryLines).h + 20;

            // Adiciona a tabela
            const headers = [['Data', 'Base', 'Atendente', 'Unidade', 'Meio', 'Disparos', 'Positivos', 'Negativos']];
            const data = filteredData.map(item => [
                item.data,
                item.nomeBase,
                item.nomeAtendente,
                item.unidade,
                item.meioDisparo,
                item.quantidadeDisparos,
                item.positivos,
                item.negativos
            ]);
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] },
                margin: { top: margin, bottom: margin, left: margin, right: margin },
                styles: { fontSize: 8 },
                columnStyles: { 
                    0: { cellWidth: 50 }, 
                    4: { cellWidth: 50 }, 
                    5: { cellWidth: 50 },
                    6: { cellWidth: 50 },
                    7: { cellWidth: 50 },
                }
            });

            doc.save("Relatorio_de_Bases.pdf");
            showMessage('Relatório em PDF gerado com sucesso!');
        });

        // Exportação para Excel (CSV)
        exportExcelBtn.addEventListener('click', () => {
            const data = filterData();
            if (data.length === 0) {
                showMessage('Não há dados para exportar.');
                return;
            }

            const header = ["Data", "Nome da Base", "Nome do Atendente", "Unidade", "Meio de Disparo", "Quantidade de Disparos", "Positivos", "Negativos", "Evidência"];
            const rows = data.map(item => [
                item.data,
                item.nomeBase,
                item.nomeAtendente,
                item.unidade,
                item.meioDisparo,
                item.quantidadeDisparos,
                item.positivos,
                item.negativos,
                // Garantir que a evidência não cause problemas no CSV
                `"${item.evidencia.replace(/"/g, '""')}"`
            ]);

            // Formatação CSV com separador de ponto e vírgula
            let csvContent = "\ufeff" + header.join(";") + "\n" + rows.map(row => row.join(";")).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
            link.setAttribute("download", "relatorio_bases.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('Relatório em Excel (CSV) gerado com sucesso!');
        });
        
        // Configuração inicial do filtro de data para 'Hoje'
        reportHojeBtn.click();

    </script>
</body>
</html>
