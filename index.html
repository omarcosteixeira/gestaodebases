<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de bases Oeste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="app" class="flex flex-1 flex-col p-4 md:p-8">
        <!-- Tela de Autenticação -->
        <div id="auth-screen" class="flex flex-col items-center justify-center flex-1">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Gestão de bases Oeste</h1>
                <div id="auth-form-container">
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Entrar</button>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Não tem uma conta? <a href="#" id="show-register" class="text-blue-600 hover:underline">Cadastre-se</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela Principal da Ferramenta -->
        <div id="main-app" class="hidden flex-1 flex-col">
            <!-- Cabeçalho -->
            <header class="bg-blue-600 text-white p-4 rounded-b-lg shadow-md mb-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Gestão de bases Oeste</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="font-semibold text-sm"></span>
                    <button id="logout-button" class="bg-white text-blue-600 px-4 py-2 rounded-md font-semibold hover:bg-gray-100 transition duration-300">Sair</button>
                </div>
            </header>

            <!-- Seções da Ferramenta -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1">
                <!-- Seção de Cadastro -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Cadastro de Base</h2>
                    <form id="base-form" class="space-y-4">
                        <div>
                            <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="data" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label for="nomeBase" class="block text-sm font-medium text-gray-700">Nome da Base</label>
                            <input type="text" id="nomeBase" placeholder="Ex: Campanha Verão" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="nomeAtendente" class="block text-sm font-medium text-gray-700">Nome do Atendente</label>
                            <input type="text" id="nomeAtendente" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                        <div>
                            <label for="meioDisparo" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="meioDisparo" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Selecione...</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                            </select>
                        </div>
                        <div>
                            <label for="quantidadeDisparos" class="block text-sm font-medium text-gray-700">Quantidade de Disparos</label>
                            <input type="number" id="quantidadeDisparos" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="positivos" class="block text-sm font-medium text-gray-700">Quantidade de Positivos</label>
                            <input type="number" id="positivos" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="negativos" class="block text-sm font-medium text-gray-700">Quantidade de Negativos</label>
                            <input type="number" id="negativos" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="evidencia" class="block text-sm font-medium text-gray-700">Evidência (URL ou Observações)</label>
                            <input type="text" id="evidencia" placeholder="Link para o relatório ou observações" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Salvar Dados</button>
                    </form>
                </div>

                <!-- Seção de Relatórios -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Relatórios</h2>
                        <div id="report-controls" class="flex space-x-2">
                            <button id="report-diario" class="px-3 py-1 text-sm rounded-full bg-blue-500 text-white font-semibold hover:bg-blue-600 transition">Diário</button>
                            <button id="report-semanal" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Semanal</button>
                            <button id="report-anual" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Anual</button>
                        </div>
                    </div>
                    
                    <div id="report-filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="filter-atendente" class="block text-sm font-medium text-gray-700">Atendente</label>
                            <select id="filter-atendente" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-meio" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="filter-meio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="all">Todos</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                            <input type="date" id="filter-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Data Final</label>
                            <input type="date" id="filter-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <canvas id="reportChart" class="w-full h-80"></canvas>
                    <div id="report-summary" class="mt-6 p-4 bg-gray-100 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Resumo</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="font-medium">Total de Disparos:</span> <span id="summary-disparos" class="font-bold">0</span></div>
                            <div><span class="font-medium">Total de Positivos:</span> <span id="summary-positivos" class="font-bold">0</span></div>
                            <div><span class="font-medium">Total de Negativos:</span> <span id="summary-negativos" class="font-bold">0</span></div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Dados Brutos -->
                    <div class="mt-8 overflow-x-auto">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Bases Cadastradas</h3>
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Data</th>
                                    <th class="py-3 px-6 text-left">Base</th>
                                    <th class="py-3 px-6 text-left">Atendente</th>
                                    <th class="py-3 px-6 text-left">Meio</th>
                                    <th class="py-3 px-6 text-left">Disparos</th>
                                    <th class="py-3 px-6 text-left">Positivos</th>
                                    <th class="py-3 px-6 text-left">Negativos</th>
                                </tr>
                            </thead>
                            <tbody id="bases-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Dados serão inseridos aqui pelo JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Seção de Administrador -->
            <div id="admin-panel" class="hidden mt-8 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Painel do Administrador</h2>
                <form id="create-user-form" class="space-y-4">
                    <h3 class="font-semibold text-gray-700">Criar Novo Usuário</h3>
                    <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-md">
                    <input type="email" id="new-user-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-md">
                    <input type="password" id="new-user-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-md">
                    <input type="text" id="new-user-unidade" placeholder="Unidade (Ex: Leste, Sul)" class="w-full p-3 border border-gray-300 rounded-md">
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-md font-semibold hover:bg-green-700 transition">Criar Usuário</button>
                </form>
            </div>
        </div>

        <!-- Pop-up de mensagens -->
        <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p id="message-text" class="text-center text-gray-800 mb-4"></p>
                <button id="close-modal" class="w-full bg-blue-600 text-white p-2 rounded-md font-semibold">OK</button>
            </div>
        </div>

    </div>

    <!-- Rodapé -->
    <footer class="text-center text-gray-500 text-xs p-4">
        Sistema Projetado por Marcos Rodrigo Teixeira
    </footer>

    <!-- Firebase e Chart.js -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        // Importações necessárias para a versão modular do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBo6SZLEEXvIM6tbRjn-Zza-IrA2uCJ_p0",
            authDomain: "gestaodebasesoeste-b8648.firebaseapp.com",
            projectId: "gestaodebasesoeste-b8648",
            storageBucket: "gestaodebasesoeste-b8648.firebasestorage.app",
            messagingSenderId: "475439316770",
            appId: "1:475439316770:web:15a56cc5a92f6d9f9d2f7b"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            showMessage('Erro ao inicializar o Firebase. Verifique a configuração.');
        }

        let currentUserId = null;
        let currentUserRole = null;
        let currentUserUnit = null;
        let allBasesData = [];
        let myChart;

        // Referências aos elementos do DOM
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerFormContainer = document.getElementById('auth-form-container');
        const baseForm = document.getElementById('base-form');
        const nomeAtendenteInput = document.getElementById('nomeAtendente');
        const adminPanel = document.getElementById('admin-panel');
        const createUserForm = document.getElementById('create-user-form');
        const userInfoSpan = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const basesTableBody = document.getElementById('bases-table-body');
        const reportDiarioBtn = document.getElementById('report-diario');
        const reportSemanalBtn = document.getElementById('report-semanal');
        const reportAnualBtn = document.getElementById('report-anual');
        const filterAtendenteSelect = document.getElementById('filter-atendente');
        const reportChartCanvas = document.getElementById('reportChart');
        const filterStartDateInput = document.getElementById('filter-start-date');
        const filterEndDateInput = document.getElementById('filter-end-date');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const closeModalBtn = document.getElementById('close-modal');

        // Função para mostrar mensagens em um modal
        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
        }
        closeModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Alterna entre login e cadastro
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.innerHTML = `
                <form id="register-form" class="space-y-4">
                    <input type="text" id="register-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="email" id="register-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="register-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="text" id="register-unidade" placeholder="Unidade (Ex: Leste, Sul)" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Cadastrar</button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">
                        Já tem uma conta? <a href="#" id="show-login" class="text-blue-600 hover:underline">Entrar</a>
                    </p>
                </div>
            `;
            // Adiciona o event listener para o novo formulário de registro
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                registerFormContainer.innerHTML = `
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-300">Entrar</button>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Não tem uma conta? <a href="#" id="show-register" class="text-blue-600 hover:underline">Cadastre-se</a>
                        </p>
                    </div>
                `;
                document.getElementById('login-form').addEventListener('submit', handleLogin);
            });
        });

        // Lidar com o login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage(`Erro ao fazer login: ${error.message}`);
            }
        }
        loginForm.addEventListener('submit', handleLogin);

        // Lidar com o registro
        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const unidade = document.getElementById('register-unidade').value;

            try {
                const adminDoc = await getDoc(doc(db, "app_state", "admin"));
                let isFirstUser = !adminDoc.exists();

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userRole = isFirstUser ? 'admin' : 'user';
                const userUnidade = isFirstUser ? 'Oeste' : unidade;

                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    unidade: userUnidade,
                    role: userRole
                });
                
                if (isFirstUser) {
                    await setDoc(doc(db, "app_state", "admin"), { adminId: user.uid });
                }
                
                showMessage(`Usuário ${name} cadastrado com sucesso!`);
            } catch (error) {
                showMessage(`Erro ao cadastrar: ${error.message}`);
            }
        }

        // Lidar com a criação de usuário pelo admin
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const unidade = document.getElementById('new-user-unidade').value;
            
            try {
                // A criação de usuários pelo admin diretamente não é suportada pela SDK Web.
                // É necessário um servidor para essa função. Para esta ferramenta,
                // vamos simular a criação apenas salvando os dados do usuário.
                // A autenticação do novo usuário será feita apenas por email/senha.
                const newUserCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", newUserCredential.user.uid), {
                    name, email, unidade, role: 'user'
                });
                showMessage(`Novo usuário (${email}) criado com sucesso!`);
                createUserForm.reset();
            } catch (error) {
                showMessage(`Erro ao criar usuário: ${error.message}`);
            }
        });
        
        // Lidar com o estado de autenticação
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuário logado
                currentUserId = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');

                // Busca dados do perfil do usuário
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    currentUserUnit = userData.unidade;
                    
                    userInfoSpan.textContent = `${userData.name} (${userData.unidade})`;
                    nomeAtendenteInput.value = userData.name;

                    // Mostra o painel de admin se for admin
                    if (currentUserRole === 'admin') {
                        adminPanel.classList.remove('hidden');
                    } else {
                        adminPanel.classList.add('hidden');
                    }
                    
                    // Inicia o listener de dados
                    setupDataListener();
                }

                // Configura a data atual
                const today = new Date().toISOString().substring(0, 10);
                document.getElementById('data').value = today;

            } else {
                // Usuário não logado
                currentUserId = null;
                currentUserRole = null;
                currentUserUnit = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                
                // Limpa o listener de dados e os filtros
                if (myChart) myChart.destroy();
                basesTableBody.innerHTML = '';
            }
        });

        // Função para configurar o listener de dados do Firestore
        function setupDataListener() {
            let basesRef = collection(db, "bases");
            let q;
            if (currentUserRole === 'admin') {
                q = query(basesRef);
            } else {
                q = query(basesRef, where("unidade", "==", currentUserUnit));
            }

            // Popula os atendentes no filtro
            getDocs(q).then(snapshot => {
                const atendentes = new Set();
                snapshot.forEach(doc => {
                    atendentes.add(doc.data().nomeAtendente);
                });
                filterAtendenteSelect.innerHTML = '<option value="all">Todos</option>';
                atendentes.forEach(atendente => {
                    filterAtendenteSelect.innerHTML += `<option value="${atendente}">${atendente}</option>`;
                });
            });

            onSnapshot(q, (snapshot) => {
                allBasesData = [];
                basesTableBody.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allBasesData.push(data);
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${data.data}</td>
                            <td class="py-3 px-6 text-left">${data.nomeBase}</td>
                            <td class="py-3 px-6 text-left">${data.nomeAtendente}</td>
                            <td class="py-3 px-6 text-left">${data.meioDisparo}</td>
                            <td class="py-3 px-6 text-left">${data.quantidadeDisparos}</td>
                            <td class="py-3 px-6 text-left">${data.positivos}</td>
                            <td class="py-3 px-6 text-left">${data.negativos}</td>
                        </tr>
                    `;
                    basesTableBody.innerHTML += row;
                });
                
                // Gera o relatório inicial
                generateReport('daily');
            }, (error) => {
                console.error("Erro ao carregar dados:", error);
            });
        }

        // Lidar com o envio do formulário de base
        baseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    data: document.getElementById('data').value,
                    nomeBase: document.getElementById('nomeBase').value,
                    nomeAtendente: nomeAtendenteInput.value,
                    meioDisparo: document.getElementById('meioDisparo').value,
                    quantidadeDisparos: parseInt(document.getElementById('quantidadeDisparos').value),
                    positivos: parseInt(document.getElementById('positivos').value),
                    negativos: parseInt(document.getElementById('negativos').value),
                    evidencia: document.getElementById('evidencia').value || "",
                    userId: currentUserId,
                    unidade: currentUserUnit,
                };
                await addDoc(collection(db, "bases"), data);
                showMessage('Dados salvos com sucesso!');
                baseForm.reset();
                document.getElementById('data').value = new Date().toISOString().substring(0, 10);
            } catch (error) {
                showMessage(`Erro ao salvar dados: ${error.message}`);
            }
        });

        // Lidar com o logout
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                showMessage(`Erro ao sair: ${error.message}`);
            }
        });

        // Lógica de geração de relatórios
        let currentReportType = 'daily';

        reportDiarioBtn.addEventListener('click', () => { generateReport('daily'); });
        reportSemanalBtn.addEventListener('click', () => { generateReport('weekly'); });
        reportAnualBtn.addEventListener('click', () => { generateReport('yearly'); });
        filterAtendenteSelect.addEventListener('change', () => { generateReport(currentReportType); });
        document.getElementById('filter-meio').addEventListener('change', () => { generateReport(currentReportType); });
        filterStartDateInput.addEventListener('change', () => { generateReport(currentReportType); });
        filterEndDateInput.addEventListener('change', () => { generateReport(currentReportType); });

        function generateReport(reportType) {
            currentReportType = reportType;
            const filteredData = filterData();
            const { labels, datasets, totalDisparos, totalPositivos, totalNegativos } = processDataForChart(filteredData, reportType);
            
            // Atualiza o resumo
            document.getElementById('summary-disparos').textContent = totalDisparos;
            document.getElementById('summary-positivos').textContent = totalPositivos;
            document.getElementById('summary-negativos').textContent = totalNegativos;

            if (myChart) {
                myChart.data.labels = labels;
                myChart.data.datasets = datasets;
                myChart.update();
            } else {
                myChart = new Chart(reportChartCanvas, {
                    type: 'bar',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, stacked: true },
                            x: { stacked: true }
                        }
                    }
                });
            }
        }

        function filterData() {
            let data = [...allBasesData];
            const atendente = filterAtendenteSelect.value;
            const meio = document.getElementById('filter-meio').value;
            const startDate = filterStartDateInput.value;
            const endDate = filterEndDateInput.value;

            if (atendente !== 'all') {
                data = data.filter(base => base.nomeAtendente === atendente);
            }
            if (meio !== 'all') {
                data = data.filter(base => base.meioDisparo === meio);
            }
            if (startDate) {
                data = data.filter(base => base.data >= startDate);
            }
            if (endDate) {
                data = data.filter(base => base.data <= endDate);
            }
            return data;
        }

        function processDataForChart(data, reportType) {
            const groupedData = {};
            let totalDisparos = 0;
            let totalPositivos = 0;
            let totalNegativos = 0;

            data.forEach(item => {
                const date = new Date(item.data);
                let key;
                if (reportType === 'daily') {
                    key = item.data;
                } else if (reportType === 'weekly') {
                    const firstDayOfWeek = new Date(date.setDate(date.getDate() - date.getDay()));
                    key = firstDayOfWeek.toISOString().substring(0, 10);
                } else if (reportType === 'yearly') {
                    key = date.getFullYear().toString();
                }

                if (!groupedData[key]) {
                    groupedData[key] = { disparos: 0, positivos: 0, negativos: 0 };
                }
                groupedData[key].disparos += item.quantidadeDisparos;
                groupedData[key].positivos += item.positivos;
                groupedData[key].negativos += item.negativos;
                
                totalDisparos += item.quantidadeDisparos;
                totalPositivos += item.positivos;
                totalNegativos += item.negativos;
            });

            const labels = Object.keys(groupedData).sort();
            const disparos = labels.map(key => groupedData[key].disparos);
            const positivos = labels.map(key => groupedData[key].positivos);
            const negativos = labels.map(key => groupedData[key].negativos);

            const datasets = [
                { label: 'Disparos', data: disparos, backgroundColor: 'rgba(59, 130, 246, 0.7)' },
                { label: 'Positivos', data: positivos, backgroundColor: 'rgba(34, 197, 94, 0.7)' },
                { label: 'Negativos', data: negativos, backgroundColor: 'rgba(239, 68, 68, 0.7)' }
            ];

            return { labels, datasets, totalDisparos, totalPositivos, totalNegativos };
        }
    </script>
</body>
</html>
