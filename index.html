<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de bases Oeste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Container principal com largura limitada para melhor visualização em telas grandes -->
    <div id="app" class="flex flex-1 flex-col p-4 md:p-8 mx-auto w-full max-w-screen-xl">
        <!-- Tela de Autenticação -->
        <div id="auth-screen" class="flex flex-col items-center justify-center flex-1">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
                <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Gestão de bases Oeste</h1>
                <div id="auth-form-container">
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Entrar</button>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Não tem uma conta? <a href="#" id="show-register" class="text-sky-600 hover:underline">Cadastre-se</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela Principal da Ferramenta -->
        <div id="main-app" class="hidden flex-1 flex-col">
            <!-- Cabeçalho -->
            <header class="bg-sky-600 text-white p-4 rounded-b-xl shadow-lg mb-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Gestão de bases Oeste</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="font-semibold text-sm"></span>
                    <button id="logout-button" class="bg-white text-sky-600 px-4 py-2 rounded-xl font-semibold hover:bg-gray-100 transition duration-300 shadow-sm">Sair</button>
                </div>
            </header>

            <!-- Seções da Ferramenta -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1">
                <!-- Seção de Cadastro -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Cadastro de Base</h2>
                    <form id="base-form" class="space-y-4">
                        <div>
                            <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="data" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="nomeBase" class="block text-sm font-medium text-gray-700">Nome da Base</label>
                            <input type="text" id="nomeBase" placeholder="Ex: Campanha Verão" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="nomeAtendente" class="block text-sm font-medium text-gray-700">Nome do Atendente</label>
                            <input type="text" id="nomeAtendente" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="meioDisparo" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="meioDisparo" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                <option value="">Selecione...</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                            </select>
                        </div>
                        <div>
                            <label for="quantidadeDisparos" class="block text-sm font-medium text-gray-700">Quantidade de Disparos</label>
                            <input type="number" id="quantidadeDisparos" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="positivos" class="block text-sm font-medium text-gray-700">Quantidade de Positivos</label>
                            <input type="number" id="positivos" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="negativos" class="block text-sm font-medium text-gray-700">Quantidade de Negativos</label>
                            <input type="number" id="negativos" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label for="evidencia" class="block text-sm font-medium text-gray-700">Evidência (URL ou Observações)</label>
                            <input type="text" id="evidencia" placeholder="Link para o relatório ou observações" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Salvar Dados</button>
                    </form>
                </div>

                <!-- Seção de Relatórios -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Relatórios</h2>
                        <div id="report-controls" class="flex space-x-2">
                            <button id="report-diario" class="px-3 py-1 text-sm rounded-full bg-sky-500 text-white font-semibold hover:bg-sky-600 transition">Diário</button>
                            <button id="report-semanal" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Semanal</button>
                            <button id="report-anual" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Anual</button>
                        </div>
                    </div>
                    
                    <div id="report-filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="filter-atendente" class="block text-sm font-medium text-gray-700">Atendente</label>
                            <select id="filter-atendente" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-meio" class="block text-sm font-medium text-gray-700">Meio de Disparo</label>
                            <select id="filter-meio" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                                <option value="all">Todos</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Telefone">Telefone</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                            <input type="date" id="filter-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Data Final</label>
                            <input type="date" id="filter-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                    <div id="report-summary" class="mt-6 p-4 bg-gray-100 rounded-xl">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Resumo</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="font-medium">Total de Disparos:</span> <span id="summary-disparos" class="font-bold">0</span></div>
                            <div><span class="font-medium">Total de Positivos:</span> <span id="summary-positivos" class="font-bold">0</span></div>
                            <div><span class="font-medium">Total de Negativos:</span> <span id="summary-negativos" class="font-bold">0</span></div>
                        </div>
                    </div>

                    <!-- Botões de Exportação -->
                    <div class="mt-6 flex justify-end space-x-4">
                        <button id="export-pdf-btn" class="bg-gray-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-gray-600 transition duration-300 shadow-md">Exportar PDF</button>
                        <button id="export-excel-btn" class="bg-green-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-600 transition duration-300 shadow-md">Exportar Excel</button>
                    </div>
                    
                    <!-- Tabela de Dados Brutos -->
                    <div class="mt-8 overflow-x-auto">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Bases Cadastradas</h3>
                        <table class="min-w-full bg-white border border-gray-200 rounded-xl">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Data</th>
                                    <th class="py-3 px-6 text-left">Base</th>
                                    <th class="py-3 px-6 text-left">Atendente</th>
                                    <th class="py-3 px-6 text-left">Meio</th>
                                    <th class="py-3 px-6 text-left">Disparos</th>
                                    <th class="py-3 px-6 text-left">Positivos</th>
                                    <th class="py-3 px-6 text-left">Negativos</th>
                                    <th class="py-3 px-6 text-left">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="bases-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Dados serão inseridos aqui pelo JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Seção de Administrador -->
            <div id="admin-panel" class="hidden mt-8 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Painel do Administrador</h2>
                
                <!-- Formulário para Criar Novo Usuário -->
                <div class="mb-8">
                    <h3 class="font-semibold text-gray-700 mb-2">Criar Novo Usuário</h3>
                    <form id="create-user-form" class="space-y-4">
                        <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-xl">
                        <input type="email" id="new-user-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl">
                        <input type="password" id="new-user-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-xl">
                        <input type="text" id="new-user-unidade" placeholder="Unidade (Ex: Leste, Sul)" class="w-full p-3 border border-gray-300 rounded-xl">
                        <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-xl font-semibold hover:bg-green-700 transition shadow-md">Criar Usuário</button>
                    </form>
                </div>

                <!-- Tabela para Gerenciar Usuários -->
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Gerenciar Usuários Existentes</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-xl">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Nome</th>
                                    <th class="py-3 px-6 text-left">E-mail</th>
                                    <th class="py-3 px-6 text-left">Unidade</th>
                                    <th class="py-3 px-6 text-left">Permissão</th>
                                    <th class="py-3 px-6 text-left">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Dados dos usuários serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pop-up de mensagens -->
        <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full">
                <p id="message-text" class="text-center text-gray-800 mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="close-modal" class="bg-sky-600 text-white p-2 rounded-xl font-semibold hover:bg-sky-700 transition">OK</button>
                    <button id="confirm-action" class="hidden bg-red-600 text-white p-2 rounded-xl font-semibold hover:bg-red-700 transition">Confirmar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Rodapé -->
    <footer class="text-center text-gray-500 text-xs p-4">
        Sistema Projetado por Marcos Rodrigo Teixeira
    </footer>

    <!-- Firebase e jsPDF -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        // Importações necessárias para a versão modular do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, onSnapshot, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBo6SZLEEXvIM6tbRjn-Zza-IrA2uCJ_p0",
            authDomain: "gestaodebasesoeste-b8648.firebaseapp.com",
            projectId: "gestaodebasesoeste-b8648",
            storageBucket: "gestaodebasesoeste-b8648.firebasestorage.app",
            messagingSenderId: "475439316770",
            appId: "1:475439316770:web:15a56cc5a92f6d9f9d2f7b"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            showMessage('Erro ao inicializar o Firebase. Verifique a configuração.');
        }

        let currentUserId = null;
        let currentUserRole = null;
        let currentUserUnit = null;
        let currentUserCanViewAllUnits = false;
        let allBasesData = [];
        let currentDeleteDocId = null;

        // Referências aos elementos do DOM
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerFormContainer = document.getElementById('auth-form-container');
        const baseForm = document.getElementById('base-form');
        const nomeAtendenteInput = document.getElementById('nomeAtendente');
        const adminPanel = document.getElementById('admin-panel');
        const createUserForm = document.getElementById('create-user-form');
        const userInfoSpan = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const basesTableBody = document.getElementById('bases-table-body');
        const reportDiarioBtn = document.getElementById('report-diario');
        const reportSemanalBtn = document.getElementById('report-semanal');
        const reportAnualBtn = document.getElementById('report-anual');
        const filterAtendenteSelect = document.getElementById('filter-atendente');
        const noDataMessage = document.getElementById('no-data-message');
        const filterStartDateInput = document.getElementById('filter-start-date');
        const filterEndDateInput = document.getElementById('filter-end-date');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const closeModalBtn = document.getElementById('close-modal');
        const confirmActionBtn = document.getElementById('confirm-action');
        const usersTableBody = document.getElementById('users-table-body');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');

        // Função para mostrar mensagens em um modal
        function showMessage(message, isConfirmation = false, onConfirm = null) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
            if (isConfirmation) {
                closeModalBtn.classList.add('hidden');
                confirmActionBtn.classList.remove('hidden');
                confirmActionBtn.onclick = onConfirm;
            } else {
                closeModalBtn.classList.remove('hidden');
                confirmActionBtn.classList.add('hidden');
            }
        }
        closeModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Alterna entre login e cadastro
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.innerHTML = `
                <form id="register-form" class="space-y-4">
                    <input type="text" id="register-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <input type="email" id="register-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <input type="password" id="register-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <input type="text" id="register-unidade" placeholder="Unidade (Ex: Leste, Sul)" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Cadastrar</button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">
                        Já tem uma conta? <a href="#" id="show-login" class="text-sky-600 hover:underline">Entrar</a>
                    </p>
                </div>
            `;
            // Adiciona o event listener para o novo formulário de registro
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                registerFormContainer.innerHTML = `
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-300 shadow-md">Entrar</button>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Não tem uma conta? <a href="#" id="show-register" class="text-sky-600 hover:underline">Cadastre-se</a>
                        </p>
                    </div>
                </div>
            `;
                document.getElementById('login-form').addEventListener('submit', handleLogin);
            });
        });

        // Lidar com o login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage(`Erro ao fazer login: ${error.message}`);
            }
        }
        loginForm.addEventListener('submit', handleLogin);

        // Lidar com o registro
        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const unidade = document.getElementById('register-unidade').value;

            try {
                const adminDoc = await getDoc(doc(db, "app_state", "admin"));
                let isFirstUser = !adminDoc.exists();

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userRole = isFirstUser ? 'admin' : 'user';
                const userUnidade = isFirstUser ? 'Oeste' : unidade;
                const canViewAllUnits = isFirstUser;

                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    unidade: userUnidade,
                    role: userRole,
                    canViewAllUnits: canViewAllUnits
                });
                
                if (isFirstUser) {
                    await setDoc(doc(db, "app_state", "admin"), { adminId: user.uid });
                }
                
                showMessage(`Usuário ${name} cadastrado com sucesso!`);
            } catch (error) {
                showMessage(`Erro ao cadastrar: ${error.message}`);
            }
        }

        // Lidar com a criação de usuário pelo admin
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const unidade = document.getElementById('new-user-unidade').value;
            
            try {
                const newUserCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", newUserCredential.user.uid), {
                    name, email, unidade, role: 'user', canViewAllUnits: false
                });
                showMessage(`Novo usuário (${email}) criado com sucesso!`);
                createUserForm.reset();
            } catch (error) {
                showMessage(`Erro ao criar usuário: ${error.message}`);
            }
        });
        
        // Lidar com o estado de autenticação
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');

                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    currentUserUnit = userData.unidade;
                    // Correção: Garante que admins sempre podem ver todas as bases
                    currentUserCanViewAllUnits = userData.canViewAllUnits || (currentUserRole === 'admin');
                    
                    userInfoSpan.textContent = `${userData.name} (${userData.unidade})`;
                    nomeAtendenteInput.value = userData.name;

                    if (currentUserRole === 'admin') {
                        adminPanel.classList.remove('hidden');
                        setupUsersListener();
                    } else {
                        adminPanel.classList.add('hidden');
                    }
                    
                    setupDataListener();
                }

            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserUnit = null;
                currentUserCanViewAllUnits = false;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                
                basesTableBody.innerHTML = '';
            }
        });

        // Configura o listener para a coleção de usuários no painel do admin
        function setupUsersListener() {
            if (currentUserRole !== 'admin') return;

            onSnapshot(collection(db, "users"), (snapshot) => {
                const usersData = [];
                snapshot.forEach(doc => {
                    usersData.push({ ...doc.data(), id: doc.id });
                });
                renderUsersTable(usersData);
            });
        }

        // Renderiza a tabela de usuários
        function renderUsersTable(users) {
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const isCurrentUser = user.id === currentUserId;
                const row = `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 px-6 text-left">${user.name}</td>
                        <td class="py-3 px-6 text-left">${user.email}</td>
                        <td class="py-3 px-6 text-left">${user.unidade}</td>
                        <td class="py-3 px-6 text-center">
                            <input type="checkbox" data-user-id="${user.id}" class="form-checkbox h-4 w-4 text-sky-600 rounded" ${user.canViewAllUnits ? 'checked' : ''} ${isCurrentUser || user.role === 'admin' ? 'disabled' : ''}>
                        </td>
                        <td class="py-3 px-6 text-center">
                            <button onclick="deleteUser('${user.id}')" class="bg-red-500 text-white px-3 py-1 text-xs rounded-xl font-semibold hover:bg-red-600 transition shadow-sm ${isCurrentUser || user.role === 'admin' ? 'opacity-50 cursor-not-allowed' : ''}" ${isCurrentUser || user.role === 'admin' ? 'disabled' : ''}>Excluir</button>
                        </td>
                    </tr>
                `;
                usersTableBody.innerHTML += row;
            });

            // Adiciona event listeners para os checkboxes de permissão
            usersTableBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const userId = e.target.dataset.userId;
                    updateUserPermission(userId, e.target.checked);
                });
            });
        }
        
        // Atualiza a permissão de um usuário
        async function updateUserPermission(userId, canViewAllUnits) {
            try {
                await updateDoc(doc(db, "users", userId), { canViewAllUnits: canViewAllUnits });
                showMessage('Permissão atualizada com sucesso.');
            } catch (error) {
                showMessage(`Erro ao atualizar a permissão: ${error.message}`);
            }
        }
        
        // Exclui um usuário
        window.deleteUser = function(userId) {
            showMessage('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.', true, async () => {
                try {
                    await deleteDoc(doc(db, "users", userId));
                    showMessage('Usuário excluído com sucesso!');
                } catch (error) {
                    showMessage(`Erro ao excluir o usuário: ${error.message}`);
                } finally {
                    messageModal.classList.add('hidden');
                }
            });
        };

        // Função para configurar o listener de dados do Firestore
        function setupDataListener() {
            let basesRef = collection(db, "bases");
            let q;
            if (currentUserRole === 'admin' || currentUserCanViewAllUnits) {
                // Admin ou usuário com permissão de ver tudo: consulta todas as bases
                q = query(basesRef);
            } else {
                // Usuário normal: consulta apenas as bases da sua unidade
                q = query(basesRef, where("unidade", "==", currentUserUnit));
            }
            
            // Adiciona listener para a coleção de bases
            onSnapshot(q, (snapshot) => {
                allBasesData = [];
                const atendentes = new Set();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allBasesData.push({ ...data, id: doc.id });
                    atendentes.add(data.nomeAtendente);
                });

                // Preenche o seletor de atendentes com os nomes encontrados
                filterAtendenteSelect.innerHTML = '<option value="all">Todos</option>';
                atendentes.forEach(atendente => {
                    filterAtendenteSelect.innerHTML += `<option value="${atendente}">${atendente}</option>`;
                });
                
                generateReport();
            }, (error) => {
                console.error("Erro ao carregar dados:", error);
            });
        }

        // Função para renderizar a tabela de bases
        function renderBasesTable(data) {
            basesTableBody.innerHTML = '';
            if (data.length === 0) {
                basesTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">Nenhum dado encontrado para esta seleção.</td></tr>`;
            } else {
                data.forEach((item) => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${item.data}</td>
                            <td class="py-3 px-6 text-left">${item.nomeBase}</td>
                            <td class="py-3 px-6 text-left">${item.nomeAtendente}</td>
                            <td class="py-3 px-6 text-left">${item.meioDisparo}</td>
                            <td class="py-3 px-6 text-left">${item.quantidadeDisparos}</td>
                            <td class="py-3 px-6 text-left">${item.positivos}</td>
                            <td class="py-3 px-6 text-left">${item.negativos}</td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="deleteBase('${item.id}')" class="bg-red-500 text-white px-3 py-1 text-xs rounded-xl font-semibold hover:bg-red-600 transition shadow-sm">Excluir</button>
                            </td>
                        </tr>
                    `;
                    basesTableBody.innerHTML += row;
                });
            }
        }

        // Função para excluir uma base
        window.deleteBase = function(docId) {
            currentDeleteDocId = docId;
            showMessage('Tem certeza que deseja excluir este relatório?', true, async () => {
                try {
                    await deleteDoc(doc(db, "bases", currentDeleteDocId));
                    showMessage('Relatório excluído com sucesso!');
                } catch (error) {
                    showMessage(`Erro ao excluir o relatório: ${error.message}`);
                } finally {
                    messageModal.classList.add('hidden');
                }
            });
        };

        // Lidar com o envio do formulário de base
        baseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    data: document.getElementById('data').value,
                    nomeBase: document.getElementById('nomeBase').value,
                    nomeAtendente: nomeAtendenteInput.value,
                    meioDisparo: document.getElementById('meioDisparo').value,
                    quantidadeDisparos: parseInt(document.getElementById('quantidadeDisparos').value),
                    positivos: parseInt(document.getElementById('positivos').value),
                    negativos: parseInt(document.getElementById('negativos').value),
                    evidencia: document.getElementById('evidencia').value || "",
                    userId: currentUserId,
                    unidade: currentUserUnit,
                };
                await addDoc(collection(db, "bases"), data);
                showMessage('Dados salvos com sucesso!');
                baseForm.reset();
            } catch (error) {
                showMessage(`Erro ao salvar dados: ${error.message}`);
            }
        });

        // Lidar com o logout
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                showMessage(`Erro ao sair: ${error.message}`);
            }
        });

        // Lógica de geração de relatórios
        reportDiarioBtn.addEventListener('click', () => { generateReport(); });
        reportSemanalBtn.addEventListener('click', () => { generateReport(); });
        reportAnualBtn.addEventListener('click', () => { generateReport(); });
        filterAtendenteSelect.addEventListener('change', () => { generateReport(); });
        document.getElementById('filter-meio').addEventListener('change', () => { generateReport(); });
        filterStartDateInput.addEventListener('change', () => { generateReport(); });
        filterEndDateInput.addEventListener('change', () => { generateReport(); });

        function generateReport() {
            const filteredData = filterData();
            
            let totalDisparos = 0;
            let totalPositivos = 0;
            let totalNegativos = 0;

            filteredData.forEach(item => {
                totalDisparos += item.quantidadeDisparos;
                totalPositivos += item.positivos;
                totalNegativos += item.negativos;
            });
            
            document.getElementById('summary-disparos').textContent = totalDisparos;
            document.getElementById('summary-positivos').textContent = totalPositivos;
            document.getElementById('summary-negativos').textContent = totalNegativos;
            
            renderBasesTable(filteredData);
        }

        function filterData() {
            let data = [...allBasesData];
            const atendente = filterAtendenteSelect.value;
            const meio = document.getElementById('filter-meio').value;
            const startDate = filterStartDateInput.value;
            const endDate = filterEndDateInput.value;

            if (atendente !== 'all') {
                data = data.filter(base => base.nomeAtendente === atendente);
            }
            if (meio !== 'all') {
                data = data.filter(base => base.meioDisparo === meio);
            }
            if (startDate) {
                data = data.filter(base => base.data >= startDate);
            }
            if (endDate) {
                data = data.filter(base => base.data <= endDate);
            }
            return data;
        }

        // Lógica de exportação para PDF e Excel
        exportPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const margin = 20;
            const basesTable = document.getElementById('bases-table-body');
            let y = margin;

            // Título do relatório
            doc.setFontSize(18);
            doc.text("Relatório de Bases", margin, y);
            y += 20;

            // Adiciona o resumo do relatório
            doc.setFontSize(14);
            doc.text("Resumo:", margin, y);
            y += 15;
            const summaryText = document.getElementById('report-summary').innerText;
            doc.setFontSize(10);
            const summaryLines = doc.splitTextToSize(summaryText, 550);
            doc.text(summaryLines, margin, y);
            y += doc.getTextDimensions(summaryLines).h + 20;

            // Adiciona a tabela
            const headers = [['Data', 'Base', 'Atendente', 'Meio', 'Disparos', 'Positivos', 'Negativos']];
            const data = Array.from(basesTable.rows).map(row => Array.from(row.cells).slice(0, 7).map(cell => cell.innerText));
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] },
                margin: { top: margin, bottom: margin, left: margin, right: margin }
            });

            doc.save("Relatorio_de_Bases.pdf");
            showMessage('Relatório em PDF gerado com sucesso!');
        });

        exportExcelBtn.addEventListener('click', () => {
            const data = filterData();
            if (data.length === 0) {
                showMessage('Não há dados para exportar.');
                return;
            }

            const header = ["Data", "Nome da Base", "Nome do Atendente", "Meio de Disparo", "Quantidade de Disparos", "Positivos", "Negativos", "Evidência"];
            const rows = data.map(item => [
                item.data,
                item.nomeBase,
                item.nomeAtendente,
                item.meioDisparo,
                item.quantidadeDisparos,
                item.positivos,
                item.negativos,
                item.evidencia
            ]);

            let csvContent = "data:text/csv;charset=utf-8," + header.join(";") + "\n" + rows.map(row => row.join(";")).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "relatorio_bases.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('Relatório em Excel (CSV) gerado com sucesso!');
        });
    </script>
</body>
</html>
